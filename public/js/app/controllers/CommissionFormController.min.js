"use strict";commission_form.controller("CommissionFormController",["$scope","$rootScope","$route","$location","$http","$uibModal","commissionFormModel","fitbookingsModel","tourguideModel",function($scope,$rootScope,$route,$location,$http,$uibModal,commissionFormModel,fitbookingsModel,tourguideModel){var fitBookingId=$route.current.params.fitBookingId;function calculateTotalSGD(commissions){var total=0,qty=1;return total+=parseFloat(null!=commissions.jewellery_sgd?commissions.jewellery_sgd:0),total+=parseFloat(null!=commissions.yong_ann_sgd?commissions.yong_ann_sgd:0),angular.forEach(commissions.commission_items,function(v,k){""!=v.qty&&null!=v.qty&&(qty=v.qty),total+=parseInt(qty)*parseFloat(null!=v.sgd?v.sgd:0)}),total.toFixed(2)}function calculateTotalRMB(commissions){var total=0,qty=1;return total+=parseFloat(null!=commissions.jewellery_rmb?commissions.jewellery_rmb:0),total+=parseFloat(null!=commissions.yong_ann_rmb?commissions.yong_ann_rmb:0),angular.forEach(commissions.commission_items,function(v,k){""!=v.qty&&null!=v.qty&&(qty=v.qty),total+=parseInt(qty)*parseFloat(null!=v.rmb?v.rmb:0)}),total.toFixed(2)}commissionFormModel.getCommissionClaimsDetails(fitBookingId).then(function(results){results.data.length>0?($scope.commissions=results.data[0],$scope.hasSubmitted=!0,$scope.commissions.date=moment().format("DD/MM/YYYY"),$scope.commissions.fit_booking_id=results.data[0].fit_bookings.id,$scope.commissions.tour_code=results.data[0].fit_bookings.tour_code,$scope.commissions.tour_leader=results.data[0].fit_bookings.tour_leader,$scope.commissions.tour_guide=results.data[0].tourguides.name,$scope.commissions.total_sgd=calculateTotalSGD($scope.commissions),$scope.commissions.total_rmb=calculateTotalRMB($scope.commissions),$scope.commissions.tour_guide_signature="",$scope.commissions.tour_leader_signature="",$scope.commissions.commission_items.length<=0&&$scope.commissions.commission_items.push({id:0,rmb:0,sgd:0,remarks:"",tourguide_commission_id:0,qty:0})):($scope.commissions={},$scope.hasSubmitted=!1,$scope.commissions.date=moment().format("DD/MM/YYYY"),$scope.commissions.commission_items=[],$scope.commissions.commission_items.push({id:0,rmb:0,sgd:0,remarks:"",tourguide_commission_id:0,qty:0}),fitbookingsModel.getBookingDetails(fitBookingId).then(function(results){results.data?($scope.commissions.fit_booking_id=results.data[0].id,$scope.commissions.tour_code=results.data[0].tour_code,$scope.commissions.tour_leader=results.data[0].tour_leader,270==results.data[0].sale_agency_id&&($scope.commissions.sgd_to_company=1,$scope.commissions.rmb_to_company=1),tourguideModel.getTourGuideDetails().then(function(results){results.data?$scope.commissions.tour_guide=results.data[0].name:console.log("Error occurred - invalid tour guide.")}).catch(function(error){401==error.status?$location.path("/"):console.log("Error occurred in retrieving tour guide details.")})):console.log("Error occurred - invalid booking.")}).catch(function(error){401==error.status?$location.path("/"):console.log("Error occurred in retrieving commission claims details.")}))}).catch(function(error){401==error.status?$location.path("/"):console.log("Error occurred in retrieving commission claims details.")}),$scope.addAttraction=function(){$scope.commissions.commission_items.push({id:0,rmb:0,sgd:0,remarks:"",tourguide_commission_id:0,qty:0})},$scope.calculateTotalSGD=function(commissions){$scope.commissions.total_sgd=calculateTotalSGD(commissions)},$scope.calculateTotalRMB=function(commissions){$scope.commissions.total_rmb=calculateTotalRMB(commissions)},$scope.submitForm=function(commissions){commissions.tour_guide_signature='{"lines":[]}'!=$("#tour_guide_signature").val()?$("#tour_guide_signature").val():"",commissions.tour_leader_signature='{"lines":[]}'!=$("#tour_leader_signature").val()?$("#tour_leader_signature").val():"",commissionFormModel.submitForms(commissions).then(function(results){void 0!==results.data.errors&&Object.keys(results.data.errors).length>0?$scope.errors=results.data.errors:("true"==results.data?$rootScope.showNotification("领队佣金单已成功提交。","success"):$rootScope.showNotification("领队佣金单未提交。","error"),$location.path("/fitbookings/forms/"+commissions.fit_booking_id))}).catch(function(error){401==error.status?$location.path("/"):console.log("Error occurred in submitting commission claim.")})},$("#TourGuideSignature").signature({syncField:$("#TourGuideSignature").next("input")}),$("#TourLeaderSignature").signature({syncField:$("#TourLeaderSignature").next("input")}),$(".clearButton a").click(function(e){e.preventDefault(),$(this).parents(".sigWrapper").find(".sigPad").signature("clear"),$(this).parents(".sigWrapper").find(".sigPad").next("input").val("")})}]);