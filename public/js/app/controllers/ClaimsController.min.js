"use strict";claims.controller("ClaimsController",["$scope","$rootScope","$route","$location","$http","$uibModal","$window","claimsModel","restaurantsModel","ticketsModel","commonModel","attractionsModel",function(t,e,o,a,i,n,s,c,r,l,u,m){var p=o.current.params.fitBookingId;r.getRestaurants().then(function(e){e.data?(t.restaurants=e.data,t.restaurants.push({id:0,name:"Others with GST 其他有消费税"},{id:999,name:"Others without GST 其他无消费税"})):console.log("There is no restaurant.")}).catch(function(t){401==t.status?a.path("/"):console.log("Error occurred in retrieving restaurants.")}),l.getTickets().then(function(e){e.data?(t.tickets=e.data,t.tickets.push({id:0,ticket:"Other tickets 其他门票"})):console.log("There is no ticket.")}).catch(function(t){401==t.status?a.path("/"):console.log("Error occurred in retrieving tickets.")}),u.getOtherExpensesClaimOptions().then(function(e){e.data?t.claim_options=e.data:console.log("There is no claim options.")}).catch(function(t){401==t.status?a.path("/"):console.log("Error occurred in retrieving claim options.")}),m.getAttractions().then(function(e){e.data?t.attractions=e.data:console.log("There is no attraction.")}).catch(function(t){401==t.status?a.path("/"):console.log("Error occurred in retrieving attractions.")}),c.getAClaim(p).then(function(e){if(e.data){if(t.claim=e.data[0],void 0===t.claim&&(t.claim={},t.claim.fit_booking_id=p),(void 0===t.claim.expenses_restaurants||t.claim.expenses_restaurants.length<=0)&&(t.claim.expenses_restaurants=[],t.claim.expenses_restaurants.push({id:"",restaurant_id:"undefined",other_restaurant:"",amount:0,claim_option_id:6})),(void 0===t.claim.expenses_fees||t.claim.expenses_fees.length<=0)&&(t.claim.expenses_fees=[],t.claim.expenses_fees.push({id:"",amount:0,claim_option_id:7})),(void 0===t.claim.expenses_taxis||t.claim.expenses_taxis.length<=0)&&(t.claim.expenses_taxis=[],t.claim.expenses_taxis.push({id:"",amount:0,claim_option_id:7})),(void 0===t.claim.expenses_tips||t.claim.expenses_tips.length<=0)&&(t.claim.expenses_tips=[],t.claim.expenses_tips.push({id:"",amount:0,claim_option_id:7})),(void 0===t.claim.ticket_expenses||t.claim.ticket_expenses.length<=0)&&(t.claim.ticket_expenses=[],t.claim.ticket_expenses.push({id:"",ticket:"",other_ticket:"",amount:0,claim_option_id:15})),void 0===t.claim.other_expenses||t.claim.other_expenses.length<=0)t.claim.other_expenses=[],t.claim.other_expenses.push({id:"",expenses:"",other_expenses:"",amount:0,claim_option_id:15}),t.claim.other_expenses.push({id:"",expenses:"",other_expenses:"",amount:0,claim_option_id:""});else{var o=!1,a=!1;angular.forEach(t.claim.other_expenses,function(t,e){15==t.claim_option_id?o=!0:t.claim_option_id>15&&(a=!0)}),o||(t.claim.other_expenses=[],t.claim.other_expenses.push({id:"",expenses:"",other_expenses:"",amount:0,claim_option_id:15})),a||t.claim.other_expenses.push({id:"",expenses:"",other_expenses:"",amount:0,claim_option_id:""})}void 0===t.claim.income_owns||t.claim.income_owns.length<=0?(t.claim.income_owns=[],t.claim.income_owns.push({id:"",attraction_id:"",other_attraction:"",selling_price:0,tl_cost:0,tg_cost:0,fee:0,qty:0,claim_option_id:2,total:0})):angular.forEach(t.claim.income_owns,function(e,o){t.calTotalIncome(e)}),void 0===t.claim.income_products||t.claim.income_products.length<=0?(t.claim.income_products=[],t.claim.income_products.push({id:"",fee:"",qty:"",claim_option_id:2,total:0})):angular.forEach(t.claim.income_products,function(e,o){t.calTotalProduct(e)}),(void 0===t.claim.other_incomes||t.claim.other_incomes.length<=0)&&(t.claim.other_incomes=[],t.claim.other_incomes.push({id:"",income:"",amount:0,claim_option_id:1})),t.calTotal(t.claim)}else console.log("Tour guide claim is empty.")}).catch(function(t){401==t.status?a.path("/"):console.log("Error occurred in retrieving tour guide claim.")}),t.addRestaurant=function(){t.claim.expenses_restaurants.push({id:"",restaurant_id:"undefined",other_restaurant:"",amount:0,claim_option_id:6})},t.addTickets=function(){t.claim.ticket_expenses.push({id:"",ticket:"undefined",other_ticket:"",amount:0,claim_option_id:15})},t.addOtherExpenses=function(){t.claim.other_expenses.push({id:"",expenses:"",other_expenses:"",amount:0,claim_option_id:""})},t.addIncomeOwn=function(){t.claim.income_owns.push({id:"",attraction_id:"",other_attraction:"",selling_price:0,tl_cost:0,tg_cost:0,fee:0,qty:0,claim_option_id:2,total:0})},t.addOtherIncome=function(){t.claim.other_incomes.push({id:"",income:"",amount:0,claim_option_id:1})},t.calTotalIncome=function(t){t.total=parseInt(t.qty)*(parseFloat(t.selling_price)-parseFloat(t.tl_cost)-parseFloat(t.tg_cost))},t.calTotalProduct=function(t){t.total=(null!=t.qty?parseInt(t.qty):0)*parseFloat(t.fee)},t.greaterThan=function(t,e){return function(o){return""==o[t]||o[t]>e}},t.calTotal=function(e){var o=0,a=0,i=0;e&&(angular.forEach(e.expenses_restaurants,function(t,e){o+=parseFloat(t.amount?t.amount:0)}),o+=parseFloat(e.expenses_fees[0].amount)+parseFloat(e.expenses_taxis[0].amount)+parseFloat(e.expenses_tips[0].amount),angular.forEach(e.ticket_expenses,function(t,e){o+=parseFloat(t.amount?t.amount:0)}),angular.forEach(e.other_expenses,function(t,e){o+=parseFloat(t.amount?t.amount:0)}),angular.forEach(e.income_owns,function(t,e){a+=parseFloat(t.total?t.total:0)}),angular.forEach(e.income_products,function(t,e){a+=parseFloat(t.total?t.total:0)}),angular.forEach(e.other_incomes,function(t,e){a+=parseFloat(t.amount?t.amount:0)}),i+=parseFloat(e.advance_cash?e.advance_cash:0)),t.totalExpenses=o,t.totalIncome=a,t.advanceCash=i,t.balance=o-a-i},t.submitForm=function(o){c.submitForms(o).then(function(i){void 0!==i.data.errors&&Object.keys(i.data.errors).length>0?t.errors=i.data.errors:("true"==i.data?e.showNotification("导游请款单已成功提交。","success"):e.showNotification("导游请款单未提交。","error"),a.path("/fitbookings/forms/"+o.fit_booking_id))}).catch(function(t){401==t.status?a.path("/"):console.log("Error occurred in submitting tour guide claim.")})},t.getClaimOption=function(e){var o="";return angular.forEach(t.claim_options,function(t,a){t.id==e&&(o=t.text)}),o}}]);